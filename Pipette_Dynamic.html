import React, { useState, useEffect, useRef } from 'react';
import { ChevronRight, Droplets, AlertTriangle, CheckCircle2, Info, ArrowDown, ArrowUp, Sparkles, Send, RefreshCcw, BrainCircuit, Users, MessageSquareShare, Save, Wifi, WifiOff, Play, Pause, RotateCcw } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { initializeFirestore, collection, doc, setDoc, onSnapshot, query, addDoc, serverTimestamp } from 'firebase/firestore';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = initializeFirestore(app, { experimentalForceLongPolling: true });
const appId = typeof __app_id !== 'undefined' ? __app_id : 'micropipette-qc-guide';

const App = () => {
  const [activeTab, setActiveTab] = useState('animation'); // 預設改為動畫模式
  const [userInput, setUserInput] = useState('');
  const [aiResponse, setAiResponse] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const [dbStatus, setDbStatus] = useState('connecting');
  const [error, setError] = useState(null);
  const [user, setUser] = useState(null);
  const [sharedTips, setSharedTips] = useState([]);

  // 動畫相關 State
  const [animMode, setAnimMode] = useState('forward'); // forward or reverse
  const [animStep, setAnimStep] = useState(0);
  const [isAutoPlay, setIsAutoPlay] = useState(false);

  // 1. Auth & Data Init
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) { console.error(err); }
    };
    initAuth();
    const unsubscribeAuth = onAuthStateChanged(auth, setUser);
    return () => unsubscribeAuth();
  }, []);

  useEffect(() => {
    if (!user) return;
    const q = collection(db, 'artifacts', appId, 'public', 'data', 'shared_qa');
    const unsubscribe = onSnapshot(q, (snapshot) => {
      setDbStatus('online');
      const tips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setSharedTips(tips.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)).slice(0, 10));
    }, () => setDbStatus('offline'));
    return () => unsubscribe();
  }, [user]);

  // 動畫邏輯定義
  const forwardSteps = [
    { label: "空操作", plunger: 0, liquid: 0, desc: "初始狀態，活塞於頂端。" },
    { label: "準備吸液", plunger: 60, liquid: 0, desc: "在大氣中壓至 第一段 (1st Stop)。" },
    { label: "吸取液體", plunger: 0, liquid: 80, desc: "浸入液面，緩慢釋放活塞，液體吸入。" },
    { label: "精確排液", plunger: 60, liquid: 0, desc: "靠壁按壓至 第一段，排出精確體積。" },
    { label: "吹出殘餘", plunger: 100, liquid: 0, desc: "按壓至 第二段 (2nd Stop)，吹出 Tip 尖端液滴。" },
    { label: "完成", plunger: 0, liquid: 0, desc: "放開活塞，更換 Tip。" }
  ];

  const reverseSteps = [
    { label: "空操作", plunger: 0, liquid: 0, desc: "初始狀態。" },
    { label: "準備吸液", plunger: 100, liquid: 0, desc: "在大氣中直接壓至 第二段 (2nd Stop)。" },
    { label: "吸取液體", plunger: 0, liquid: 100, desc: "緩慢釋放活塞，吸入量會包含補償用的過量液體。" },
    { label: "精確排液", plunger: 60, liquid: 20, desc: "按壓至 第一段 即停止。Tip 內應保留殘液！" },
    { label: "棄置殘液", plunger: 100, liquid: 0, desc: "將 Tip 內剩餘液體排入廢棄容器，不可吹入檢體。" },
    { label: "完成", plunger: 0, liquid: 0, desc: "完成高黏度/易起泡液體取樣。" }
  ];

  const currentSteps = animMode === 'forward' ? forwardSteps : reverseSteps;

  useEffect(() => {
    let timer;
    if (isAutoPlay) {
      timer = setInterval(() => {
        setAnimStep((prev) => (prev + 1) % currentSteps.length);
      }, 2500);
    }
    return () => clearInterval(timer);
  }, [isAutoPlay, animMode]);

  // Gemini API
  const fetchAiAdvice = async (type) => {
    if (!userInput.trim()) return;
    setIsLoading(true);
    setAiResponse(null);
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: `你是一位資深藥廠 QC 專家。情境：${userInput}。請判斷操作與風險，給予繁體中文建議。` }] }]
        })
      });
      const data = await response.json();
      setAiResponse(data.candidates?.[0]?.content?.parts?.[0]?.text);
    } catch (err) { setError("AI 暫時無法連線"); }
    setIsLoading(false);
  };

  return (
    <div className="min-h-screen bg-slate-100 p-4 md:p-8 font-sans text-slate-900">
      <div className="max-w-5xl mx-auto">
        {/* Header */}
        <header className="bg-slate-900 text-white p-6 rounded-t-3xl shadow-2xl relative border-b-4 border-blue-500">
          <div className="flex justify-between items-center">
            <div>
              <h1 className="text-2xl md:text-3xl font-black tracking-tight flex items-center gap-3">
                <Droplets className="text-blue-400 animate-pulse" /> 
                QC 移液管動態操作模擬
              </h1>
              <p className="text-slate-400 text-xs mt-1 uppercase tracking-widest">Pharmaceutical Standard Operations Guide</p>
            </div>
            <div className="flex items-center gap-2">
               {dbStatus === 'online' ? <Wifi className="w-4 h-4 text-green-400" /> : <WifiOff className="w-4 h-4 text-red-400" />}
            </div>
          </div>
        </header>

        {/* Tabs */}
        <nav className="flex bg-white shadow-sm overflow-x-auto sticky top-0 z-20">
          {[
            { id: 'animation', label: '動態模擬教學', icon: <Play className="w-4 h-4" /> },
            { id: 'selection', label: '類型選擇', icon: <CheckCircle2 className="w-4 h-4" /> },
            { id: 'ai', label: 'AI 助手', icon: <Sparkles className="w-4 h-4" /> },
            { id: 'board', label: '同仁筆記', icon: <Users className="w-4 h-4" /> }
          ].map(tab => (
            <button 
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`flex-1 py-4 px-6 text-sm font-bold transition-all flex items-center justify-center gap-2 border-b-2 ${activeTab === tab.id ? 'text-blue-600 border-blue-600 bg-blue-50/50' : 'text-slate-500 border-transparent hover:text-slate-800'}`}
            >
              {tab.icon} {tab.label}
            </button>
          ))}
        </nav>

        <main className="bg-white p-6 md:p-10 rounded-b-3xl shadow-xl min-h-[650px]">
          
          {/* Animation Content */}
          {activeTab === 'animation' && (
            <div className="animate-in fade-in zoom-in-95 duration-500">
              <div className="flex flex-col lg:flex-row gap-10">
                {/* Left: Simulation Canvas */}
                <div className="flex-1 bg-slate-50 rounded-2xl p-8 border border-slate-200 flex flex-col items-center justify-center relative min-h-[400px]">
                  
                  {/* Pipette Plunger UI */}
                  <div className="absolute left-8 top-10 flex flex-col items-center">
                    <span className="text-[10px] font-bold text-slate-400 mb-2">活塞深度</span>
                    <div className="w-6 h-48 bg-slate-200 rounded-full p-1 relative">
                       {/* Stops indicators */}
                       <div className="absolute w-full border-t border-slate-400 top-[60%] left-0"></div>
                       <div className="absolute w-full border-t border-red-400 top-[95%] left-0"></div>
                       {/* Plunger */}
                       <div 
                         className="w-4 bg-slate-800 rounded-full transition-all duration-700 ease-in-out absolute top-1 left-1" 
                         style={{ height: `${currentSteps[animStep].plunger}%`, maxHeight: '96%' }}
                       />
                    </div>
                    <div className="mt-2 text-[10px] text-slate-500">
                       {currentSteps[animStep].plunger >= 95 ? "2nd Stop" : currentSteps[animStep].plunger >= 55 ? "1st Stop" : "Rest"}
                    </div>
                  </div>

                  {/* Main Pipette Visual */}
                  <div className="flex flex-col items-center translate-y-[-20px]">
                    {/* Pipette Body */}
                    <div className="w-16 h-40 bg-slate-300 rounded-xl relative shadow-inner">
                      <div className="absolute bottom-0 w-8 h-4 bg-slate-400 left-4"></div>
                    </div>
                    {/* Tip & Liquid */}
                    <div className="relative">
                      <svg width="60" height="120" viewBox="0 0 60 120">
                        {/* Tip Outline */}
                        <path d="M15,0 L45,0 L32,110 L28,110 Z" fill="#e2e8f0" stroke="#94a3b8" strokeWidth="2" />
                        {/* Liquid Content */}
                        <path 
                          d={`M${28 + (1-currentSteps[animStep].liquid/100)*6},${110 - (currentSteps[animStep].liquid/100)*100} L${32 - (1-currentSteps[animStep].liquid/100)*6},${110 - (currentSteps[animStep].liquid/100)*100} L32,110 L28,110 Z`} 
                          fill="#60a5fa" 
                          className="transition-all duration-700 ease-in-out"
                        />
                      </svg>
                      {/* Bubble Warning for errors */}
                      {animMode === 'forward' && animStep === 2 && currentSteps[animStep].plunger === 0 && (
                        <div className="absolute top-10 right-[-30px] animate-bounce text-blue-400">
                          <Droplets className="w-4 h-4" />
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Container/Beaker */}
                  <div className="w-32 h-24 border-x-4 border-b-4 border-slate-300 rounded-b-xl mt-[-5px] bg-blue-50/20 relative">
                     <div className="absolute bottom-0 w-full h-8 bg-blue-100/50"></div>
                  </div>
                </div>

                {/* Right: Controls & Description */}
                <div className="lg:w-80 flex flex-col gap-6">
                  <div className="bg-slate-900 text-white p-6 rounded-2xl shadow-lg">
                    <div className="flex gap-2 mb-4">
                      <button 
                        onClick={() => {setAnimMode('forward'); setAnimStep(0);}}
                        className={`flex-1 py-2 text-xs rounded-lg font-bold border ${animMode === 'forward' ? 'bg-blue-600 border-blue-600' : 'bg-transparent border-slate-700 text-slate-400'}`}
                      >
                        正向吸液
                      </button>
                      <button 
                        onClick={() => {setAnimMode('reverse'); setAnimStep(0);}}
                        className={`flex-1 py-2 text-xs rounded-lg font-bold border ${animMode === 'reverse' ? 'bg-orange-600 border-orange-600' : 'bg-transparent border-slate-700 text-slate-400'}`}
                      >
                        反向吸液
                      </button>
                    </div>

                    <div className="space-y-4">
                      <div className="flex justify-between items-center">
                        <h4 className="font-black text-blue-400">STEP {animStep + 1}</h4>
                        <span className="text-[10px] bg-slate-800 px-2 py-1 rounded">{currentSteps[animStep].label}</span>
                      </div>
                      <p className="text-sm leading-relaxed text-slate-300 min-h-[60px]">
                        {currentSteps[animStep].desc}
                      </p>
                    </div>

                    <div className="flex gap-3 mt-6">
                      <button 
                        onClick={() => setIsAutoPlay(!isAutoPlay)}
                        className="flex-1 bg-white text-slate-900 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-blue-50 transition-colors"
                      >
                        {isAutoPlay ? <Pause className="w-4 h-4" /> : <Play className="w-4 h-4" />}
                        {isAutoPlay ? "暫停" : "播放動畫"}
                      </button>
                      <button 
                        onClick={() => {setAnimStep(0); setIsAutoPlay(false);}}
                        className="p-3 bg-slate-800 rounded-xl hover:bg-slate-700"
                      >
                        <RotateCcw className="w-5 h-5" />
                      </button>
                    </div>
                  </div>

                  <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-xl text-xs text-yellow-800 leading-relaxed">
                    <div className="font-bold mb-1 flex items-center gap-1"><AlertTriangle className="w-3 h-3" /> 主管劃重點：</div>
                    {animMode === 'forward' 
                      ? "正向吸液最怕按到第二段才吸液，會導致氣泡進入 Tip。排液時則必須按到第二段以清空液體。" 
                      : "反向吸液的核心在於「吸液按到底、排液留一段」。若排液時按到底，會將補償用的多餘液體排入，造成 Assay 結果偏高 (OOS)。"}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Selection Guide */}
          {activeTab === 'selection' && (
             <div className="grid md:grid-cols-2 gap-8 animate-in fade-in slide-in-from-bottom-5">
                <div className="bg-blue-50/50 p-8 rounded-3xl border border-blue-100 flex flex-col">
                  <h3 className="text-xl font-black text-blue-800 mb-4 flex items-center gap-2">
                    <CheckCircle2 /> 正向吸液 (Forward)
                  </h3>
                  <ul className="space-y-3 text-sm text-slate-700 flex-1">
                    <li className="flex items-start gap-2"><div className="w-1.5 h-1.5 rounded-full bg-blue-500 mt-1.5" /> 適用於多數水性溶液 (Water, Buffers)。</li>
                    <li className="flex items-start gap-2"><div className="w-1.5 h-1.5 rounded-full bg-blue-500 mt-1.5" /> 用於標準品 (Standard) 配製。</li>
                    <li className="flex items-start gap-2"><div className="w-1.5 h-1.5 rounded-full bg-blue-500 mt-1.5" /> 操作口訣：一壓吸、一壓二吹排。</li>
                  </ul>
                  <div className="mt-6 p-4 bg-white rounded-2xl text-[11px] text-blue-600 font-bold border border-blue-200">
                    注意：吸液前必須先在大氣中壓至第一段，不可在液體內才按壓，否則會產生氣泡。
                  </div>
                </div>
                <div className="bg-orange-50/50 p-8 rounded-3xl border border-orange-100 flex flex-col">
                  <h3 className="text-xl font-black text-orange-800 mb-4 flex items-center gap-2">
                    <AlertTriangle /> 反向吸液 (Reverse)
                  </h3>
                  <ul className="space-y-3 text-sm text-slate-700 flex-1">
                    <li className="flex items-start gap-2"><div className="w-1.5 h-1.5 rounded-full bg-orange-500 mt-1.5" /> 適用於黏稠液體 (Glycerol, Syrup)。</li>
                    <li className="flex items-start gap-2"><div className="w-1.5 h-1.5 rounded-full bg-orange-500 mt-1.5" /> 適用於易起泡檢體 (Protein, Tween)。</li>
                    <li className="flex items-start gap-2"><div className="w-1.5 h-1.5 rounded-full bg-orange-500 mt-1.5" /> 操作口訣：二壓吸、一壓排、餘液棄。</li>
                  </ul>
                  <div className="mt-6 p-4 bg-white rounded-2xl text-[11px] text-orange-600 font-bold border border-orange-200">
                    注意：此法會補償 Tip 內壁的物理殘留，因此排液後 Tip 內一定會有液體剩餘。
                  </div>
                </div>
             </div>
          )}

          {/* AI Tab (Gemini API Integration) */}
          {activeTab === 'ai' && (
            <div className="max-w-2xl mx-auto space-y-6">
              <div className="bg-slate-900 rounded-3xl p-8 shadow-2xl border-b-8 border-blue-600">
                <h3 className="text-white font-black text-lg mb-4 flex items-center gap-2">
                  <BrainCircuit className="text-blue-400" /> AI 實驗室合規助手
                </h3>
                <textarea 
                  className="w-full bg-slate-800 border-none rounded-2xl p-4 text-white text-sm focus:ring-2 focus:ring-blue-500 transition-all outline-none"
                  rows="4"
                  placeholder="請描述檢體狀態（如：這批原料很黏稠）或發生的錯誤..."
                  value={userInput}
                  onChange={(e) => setUserInput(e.target.value)}
                />
                <div className="flex gap-4 mt-6">
                   <button onClick={() => fetchAiAdvice('judge')} disabled={isLoading || !userInput} className="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl disabled:opacity-50 transition-all shadow-lg shadow-blue-900/40">
                     {isLoading ? <RefreshCcw className="animate-spin mx-auto w-5 h-5" /> : "判定吸液類型"}
                   </button>
                   <button onClick={() => fetchAiAdvice('oos')} disabled={isLoading || !userInput} className="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-xl disabled:opacity-50 transition-all">
                     分析 OOS 風險
                   </button>
                </div>
              </div>
              {aiResponse && (
                <div className="bg-blue-50 p-6 rounded-3xl border border-blue-100 animate-in slide-in-from-top-4">
                  <div className="flex justify-between items-center mb-4">
                    <span className="text-blue-800 font-black text-sm flex items-center gap-2"><Sparkles className="w-4 h-4" /> AI 專家分析結果</span>
                    <button onClick={() => {
                      addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'shared_qa'), {
                        question: userInput, answer: aiResponse, userName: `分析員 ${user.uid.substring(0,4)}`, timestamp: serverTimestamp()
                      });
                      setActiveTab('board');
                    }} className="text-[10px] bg-white px-3 py-1 rounded-full border border-blue-200 hover:bg-blue-100 transition-colors">共享至團隊看板</button>
                  </div>
                  <p className="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap">{aiResponse}</p>
                </div>
              )}
            </div>
          )}

          {/* Shared Board */}
          {activeTab === 'board' && (
            <div className="space-y-4">
              <h3 className="font-black text-xl flex items-center gap-2"><Users className="text-blue-600" /> 團隊操作經驗共享</h3>
              <p className="text-xs text-slate-500 mb-6">透過 AI 分析並存檔的案例，幫助團隊統一操作認知。</p>
              <div className="grid md:grid-cols-2 gap-4">
                {sharedTips.map(tip => (
                  <div key={tip.id} className="p-5 rounded-2xl bg-slate-50 border border-slate-200 hover:shadow-md transition-shadow">
                    <div className="flex justify-between items-center mb-2">
                      <span className="text-[10px] font-bold text-blue-600">{tip.userName}</span>
                      <span className="text-[9px] text-slate-400">{tip.timestamp?.toDate().toLocaleString()}</span>
                    </div>
                    <p className="text-xs font-bold text-slate-800 mb-2 underline decoration-blue-200">情境：{tip.question}</p>
                    <p className="text-[11px] text-slate-600 italic leading-relaxed">{tip.answer}</p>
                  </div>
                ))}
              </div>
            </div>
          )}

        </main>

        <footer className="mt-8 text-center text-slate-400 text-[10px] flex flex-col items-center gap-2 pb-12">
          <div className="flex items-center gap-4">
            <span>USER: {user?.uid || 'GUEST'}</span>
            <span>SYSTEM: QC-V-SIMULATION-4.0</span>
          </div>
          <p>© 2025 QC Laboratory Excellence Program | 製藥業品質控制標準操作模擬</p>
        </footer>
      </div>
    </div>
  );
};

export default App;
